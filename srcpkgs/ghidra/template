# Template file for 'ghidra'
pkgname=ghidra
version=9.0.4
revision=1
wrksrc=ghidra
create_wrksrc=yes
hostmakedepends="gradle curl unzip bison flex openjdk-11"
makedepends=""
depends="openjdk-11"
short_desc="Software reverse engineering (SRE) framework"
maintainer="Kyle Nusbaum <knusbaum+void@sdf.org>"
license="Apache-2.0"
homepage="https://www.nsa.gov/resources/everyone/ghidra"
distfiles="https://github.com/NationalSecurityAgency/ghidra/archive/Ghidra_${version}_build.tar.gz
https://github.com/pxb1988/dex2jar/releases/download/2.0/dex-tools-2.0.zip
https://sourceforge.net/projects/catacombae/files/HFSExplorer/0.21/hfsexplorer-0_21-bin.zip
https://sourceforge.net/projects/yajsw/files/yajsw/yajsw-stable-12.12/yajsw-stable-12.12.zip
https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/android4me/AXMLPrinter2.jar"
checksum="e24593fb4cf3e1d1b7a8dfeae85edfba9fd9d446b360c7a5d12e9640438735e3
 7907eb4d6e9280b6e17ddce7ee0507eae2ef161ee29f70a10dbc6944fdca75bc
 90c9b54798abca5b12f4a678db7d0a4c970f4702cb153c11919536d0014dedbf
 1398fcb1e93abb19992c4fa06d7fe5758aabb4c45781d7ef306c6f57ca7a7321
 00ed038eb6abaf6ddec8d202a3ed7a81b521458f4cd459948115cfd02ff59d6d"
skip_extraction="AXMLPrinter2.jar"
nopie=true

do_configure() {
	mkdir -p ~/.gradle/init.d
	mkdir -p ~/flatRepo
	cat <<EOF > ~/.gradle/init.d/repos.gradle
ext.HOME = System.getProperty('user.home')

allprojects {
	repositories {
		mavenCentral()
		jcenter()
		flatDir name:'flat', dirs:["$HOME/flatRepo"]
	}
}
EOF
}

pre_build() {

	# Place `AXMLPrinter2.jar` in `~/flatRepo`:
	cp ${XBPS_SRCDISTDIR}/${pkgname}-${version}/AXMLPrinter2.jar ~/flatRepo/

	## Copy Other Dependencies:
	cp lib/csframework.jar lib/hfsx_dmglib.jar lib/hfsx.jar lib/iharder-base64.jar ~/flatRepo/
	cp dex2jar-2.0/lib/dex-*.jar ~/flatRepo/

	# Building the GhidraServer requires "Yet another Java service wrapper" (yajsw) version 12.12.
	# Download `yajsw-stable-12.12.zip` from their project on www.sourceforge.net, and place it in a directory named:
	# `ghidra.bin/Ghidra/Features/GhidraServer/`. Note that `ghidra.bin` must be a sibling of `ghidra`
	# Unfortunately this seems to be a fairly hard requirement of the build, so we just follow the instructions.
	pushd /tmp
	mkdir -p ${wrksrc}/ghidra.bin/Ghidra/Features/GhidraServer/
	cp ${XBPS_SRCDISTDIR}/${pkgname}-${version}/yajsw-stable-12.12.zip ${wrksrc}/ghidra.bin/Ghidra/Features/GhidraServer/
	popd

	cd ghidra-Ghidra_9.0.4_build
	gradle yajswDevUnpack
}

do_build() {
	cd ghidra-Ghidra_9.0.4_build
	gradle buildGhidra
}

do_install() {
	vlicense LICENSE.txt

	mkdir ghidra_dist
	cd ghidra_dist
	unzip "../ghidra-Ghidra_${version}_build/build/dist/ghidra*.zip"
	vmkdir usr/lib/ghidra
	vmkdir usr/bin
	vcopy "ghidra*/*" usr/lib/ghidra/
	ln -s /usr/lib/ghidra/ghidraRun ${DESTDIR}/usr/bin/ghidra
}
