# Template file for 'openjdk-11'
_java_ver=11
_jdk_update=28
_openjdk_version="openjdk-${_java_ver}"


pkgname=openjdk-11
version="${_java_ver}+${_jdk_update}"
revision=1
wrksrc="jdk${_java_ver}-jdk-${version}"
build_style=gnu-configure
configure_args="
 --disable-warnings-as-errors
 --prefix=${XBPS_DESTDIR}/${XBPS_CROSS_TRIPLET}/${pkgname}-${version}/usr/lib
 --with-update-version=${_jdk_update}
 --with-milestone=fcs
 --enable-unlimited-crypto
 --with-zlib=system
 --with-boot-jdk=/usr/lib/jvm/openjdk-11-bin"

make_build_args="jdk docs"
hostmakedepends="pkg-config automake autoconf cpio unzip zip ca-certificates libressl zlib-devel"
hostmakedepends+=" openjdk-11-bin"
makedepends="libXrender-devel libXtst-devel libXt-devel
 libjpeg-turbo-devel cups-devel freetype-devel alsa-lib-devel fontconfig-devel zlib-devel"
provides="java-environment-${version}_1"
short_desc="OpenJDK Java Development Kit"
maintainer="Kyle Nusbaum <knusbaum+void@sdf.org>"
license="GPL-2.0-or-later"
homepage="http://openjdk.java.net/"
distfiles="https://hg.openjdk.java.net/jdk/jdk${_java_ver}/archive/jdk-${version}.tar.gz"
checksum=8c1c11a7b0771a6db1084dba5d9848f8947756d0af33732bba26c79bc5790d51

# Build is still parallel, but don't use -jN.
disable_parallel_build=yes

alternatives="
 java:/usr/bin/java:/usr/lib/jvm/openjdk-11/bin/java
 java:/usr/bin/jjs:/usr/lib/jvm/openjdk-11/bin/jjs
 java:/usr/bin/keytool:/usr/lib/jvm/openjdk-11/bin/keytool
 java:/usr/bin/mkcacerts:/usr/lib/jvm/openjdk-11/bin/mkcacerts
 java:/usr/bin/orbd:/usr/lib/jvm/openjdk-11/bin/orbd
 java:/usr/bin/pack200:/usr/lib/jvm/openjdk-11/bin/pack200
 java:/usr/bin/policytool:/usr/lib/jvm/openjdk-11/bin/policytool
 java:/usr/bin/rmid:/usr/lib/jvm/openjdk-11/bin/rmid
 java:/usr/bin/rmiregistry:/usr/lib/jvm/openjdk-11/bin/rmiregistry
 java:/usr/bin/servertool:/usr/lib/jvm/openjdk-11/bin/servertool
 java:/usr/bin/tnameserv:/usr/lib/jvm/openjdk-11/bin/tnameserv
 java:/usr/bin/unpack200:/usr/lib/jvm/openjdk-11/bin/unpack200

 jdk:/usr/bin/appletviewer:/usr/lib/jvm/openjdk-11/bin/appletviewer
 jdk:/usr/bin/extcheck:/usr/lib/jvm/openjdk-11/bin/extcheck
 jdk:/usr/bin/idlj:/usr/lib/jvm/openjdk-11/bin/idlj
 jdk:/usr/bin/jar:/usr/lib/jvm/openjdk-11/bin/jar
 jdk:/usr/bin/jarsigner:/usr/lib/jvm/openjdk-11/bin/jarsigner
 jdk:/usr/bin/java:/usr/lib/jvm/openjdk-11/bin/java
 jdk:/usr/bin/java-rmi.cgi:/usr/lib/jvm/openjdk-11/bin/java-rmi.cgi
 jdk:/usr/bin/javac:/usr/lib/jvm/openjdk-11/bin/javac
 jdk:/usr/bin/javadoc:/usr/lib/jvm/openjdk-11/bin/javadoc
 jdk:/usr/bin/javah:/usr/lib/jvm/openjdk-11/bin/javah
 jdk:/usr/bin/javap:/usr/lib/jvm/openjdk-11/bin/javap
 jdk:/usr/bin/jcmd:/usr/lib/jvm/openjdk-11/bin/jcmd
 jdk:/usr/bin/jconsole:/usr/lib/jvm/openjdk-11/bin/jconsole
 jdk:/usr/bin/jdb:/usr/lib/jvm/openjdk-11/bin/jdb
 jdk:/usr/bin/jdeps:/usr/lib/jvm/openjdk-11/bin/jdeps
 jdk:/usr/bin/jhat:/usr/lib/jvm/openjdk-11/bin/jhat
 jdk:/usr/bin/jinfo:/usr/lib/jvm/openjdk-11/bin/jinfo
 jdk:/usr/bin/jjs:/usr/lib/jvm/openjdk-11/bin/jjs
 jdk:/usr/bin/jmap:/usr/lib/jvm/openjdk-11/bin/jmap
 jdk:/usr/bin/jps:/usr/lib/jvm/openjdk-11/bin/jps
 jdk:/usr/bin/jrunscript:/usr/lib/jvm/openjdk-11/bin/jrunscript
 jdk:/usr/bin/jsadebugd:/usr/lib/jvm/openjdk-11/bin/jsadebugd
 jdk:/usr/bin/jstack:/usr/lib/jvm/openjdk-11/bin/jstack
 jdk:/usr/bin/jstat:/usr/lib/jvm/openjdk-11/bin/jstat
 jdk:/usr/bin/jstatd:/usr/lib/jvm/openjdk-11/bin/jstatd
 jdk:/usr/bin/keytool:/usr/lib/jvm/openjdk-11/bin/keytool
 jdk:/usr/bin/native2ascii:/usr/lib/jvm/openjdk-11/bin/native2ascii
 jdk:/usr/bin/orbd:/usr/lib/jvm/openjdk-11/bin/orbd
 jdk:/usr/bin/pack200:/usr/lib/jvm/openjdk-11/bin/pack200
 jdk:/usr/bin/policytool:/usr/lib/jvm/openjdk-11/bin/policytool
 jdk:/usr/bin/rmic:/usr/lib/jvm/openjdk-11/bin/rmic
 jdk:/usr/bin/rmid:/usr/lib/jvm/openjdk-11/bin/rmid
 jdk:/usr/bin/rmiregistry:/usr/lib/jvm/openjdk-11/bin/rmiregistry
 jdk:/usr/bin/schemagen:/usr/lib/jvm/openjdk-11/bin/schemagen
 jdk:/usr/bin/serialver:/usr/lib/jvm/openjdk-11/bin/serialver
 jdk:/usr/bin/servertool:/usr/lib/jvm/openjdk-11/bin/servertool
 jdk:/usr/bin/tnameserv:/usr/lib/jvm/openjdk-11/bin/tnameserv
 jdk:/usr/bin/unpack200:/usr/lib/jvm/openjdk-11/bin/unpack200
 jdk:/usr/bin/wsgen:/usr/lib/jvm/openjdk-11/bin/wsgen
 jdk:/usr/bin/wsimport:/usr/lib/jvm/openjdk-11/bin/wsimport
 jdk:/usr/bin/xjc:/usr/lib/jvm/openjdk-11/bin/xjc
"

post_extract() {
	chmod +x configure
}

do_configure() {
	CFLAGS=${CFLAGS/-D_FORTIFY_SOURCE=2/}
	CXXFLAGS=${CXXFLAGS/-D_FORTIFY_SOURCE=2/}
	configure_args=${configure_args/--with-libtool-sysroot=\/usr\/[a-z0-9]*-linux-gnu/}
	./configure ${configure_args} --with-extra-cflags="$CFLAGS" --with-extra-cxxflags="$CXXFLAGS" --with-extra-ldflags="$LDFLAGS"
}

post_install() {
	vmkdir /usr/lib/jvm
	mv ${DESTDIR}/usr/lib/jvm/openjdk-11-internal ${DESTDIR}/usr/lib/jvm/openjdk-11
	rm -rf ${DESTDIR}/usr/lib/bin
	vinstall ${FILESDIR}/mkcacerts 755 usr/lib/jvm/$_openjdk_version/bin
	vmkdir usr/lib/jvm/$_openjdk_version/lib/security
	sh ${FILESDIR}/mkcacerts \
		-d "/usr/share/ca-certificates/" \
		-s "/usr/bin/openssl"  \
		-k "${DESTDIR}/usr/lib/jvm/$_openjdk_version/bin/keytool" \
		-o "${DESTDIR}/usr/lib/jvm/$_openjdk_version/lib/security/cacerts"
	vlicense ASSEMBLY_EXCEPTION
	vlicense LICENSE
}

openjdk-11-doc_package() {
	nostrip=yes
	noverifyrdeps=yes
	noshlibprovides=yes
	short_desc+=" -- documentation"
	pkg_install() {
		cd ${wrksrc}
		vmkdir usr/share/doc/openjdk-11
		cp -a build/linux-*/images/docs/* ${PKGDESTDIR}/usr/share/doc/openjdk-11
	}
}

openjdk-11-src_package() {
	nostrip=yes
	noverifyrdeps=yes
	noshlibprovides=yes
	short_desc+=" -- sources"
	pkg_install() {
		vmove "usr/lib/jvm/openjdk-11/lib/src.zip"
	}
}
